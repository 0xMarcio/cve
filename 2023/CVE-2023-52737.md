### [CVE-2023-52737](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52737)
![](https://img.shields.io/static/v1?label=Product&message=Linux&color=blue)
![](https://img.shields.io/static/v1?label=Version&message=&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=1da177e4c3f41524e886b7f1b8a0c1fc7321cac2%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Vulnerability&message=n%2Fa&color=blue)

### Description

In the Linux kernel, the following vulnerability has been resolved:btrfs: lock the inode in shared mode before starting fiemapCurrently fiemap does not take the inode's lock (VFS lock), it only locksa file range in the inode's io tree. This however can lead to a deadlockif we have a concurrent fsync on the file and fiemap code triggers a faultwhen accessing the user space buffer with fiemap_fill_next_extent(). Thedeadlock happens on the inode's i_mmap_lock semaphore, which is taken bothby fsync and btrfs_page_mkwrite(). This deadlock was recently reported bysyzbot and triggers a trace like the following:   task:syz-executor361 state:D stack:20264 pid:5668  ppid:5119   flags:0x00004004   Call Trace:    <TASK>    context_switch kernel/sched/core.c:5293 [inline]    __schedule+0x995/0xe20 kernel/sched/core.c:6606    schedule+0xcb/0x190 kernel/sched/core.c:6682    wait_on_state fs/btrfs/extent-io-tree.c:707 [inline]    wait_extent_bit+0x577/0x6f0 fs/btrfs/extent-io-tree.c:751    lock_extent+0x1c2/0x280 fs/btrfs/extent-io-tree.c:1742    find_lock_delalloc_range+0x4e6/0x9c0 fs/btrfs/extent_io.c:488    writepage_delalloc+0x1ef/0x540 fs/btrfs/extent_io.c:1863    __extent_writepage+0x736/0x14e0 fs/btrfs/extent_io.c:2174    extent_write_cache_pages+0x983/0x1220 fs/btrfs/extent_io.c:3091    extent_writepages+0x219/0x540 fs/btrfs/extent_io.c:3211    do_writepages+0x3c3/0x680 mm/page-writeback.c:2581    filemap_fdatawrite_wbc+0x11e/0x170 mm/filemap.c:388    __filemap_fdatawrite_range mm/filemap.c:421 [inline]    filemap_fdatawrite_range+0x175/0x200 mm/filemap.c:439    btrfs_fdatawrite_range fs/btrfs/file.c:3850 [inline]    start_ordered_ops fs/btrfs/file.c:1737 [inline]    btrfs_sync_file+0x4ff/0x1190 fs/btrfs/file.c:1839    generic_write_sync include/linux/fs.h:2885 [inline]    btrfs_do_write_iter+0xcd3/0x1280 fs/btrfs/file.c:1684    call_write_iter include/linux/fs.h:2189 [inline]    new_sync_write fs/read_write.c:491 [inline]    vfs_write+0x7dc/0xc50 fs/read_write.c:584    ksys_write+0x177/0x2a0 fs/read_write.c:637    do_syscall_x64 arch/x86/entry/common.c:50 [inline]    do_syscall_64+0x3d/0xb0 arch/x86/entry/common.c:80    entry_SYSCALL_64_after_hwframe+0x63/0xcd   RIP: 0033:0x7f7d4054e9b9   RSP: 002b:00007f7d404fa2f8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001   RAX: ffffffffffffffda RBX: 00007f7d405d87a0 RCX: 00007f7d4054e9b9   RDX: 0000000000000090 RSI: 0000000020000000 RDI: 0000000000000006   RBP: 00007f7d405a51d0 R08: 0000000000000000 R09: 0000000000000000   R10: 0000000000000000 R11: 0000000000000246 R12: 61635f65646f6e69   R13: 65646f7475616f6e R14: 7261637369646f6e R15: 00007f7d405d87a8    </TASK>   INFO: task syz-executor361:5697 blocked for more than 145 seconds.         Not tainted 6.2.0-rc3-syzkaller-00376-g7c6984405241 #0   "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.   task:syz-executor361 state:D stack:21216 pid:5697  ppid:5119   flags:0x00004004   Call Trace:    <TASK>    context_switch kernel/sched/core.c:5293 [inline]    __schedule+0x995/0xe20 kernel/sched/core.c:6606    schedule+0xcb/0x190 kernel/sched/core.c:6682    rwsem_down_read_slowpath+0x5f9/0x930 kernel/locking/rwsem.c:1095    __down_read_common+0x54/0x2a0 kernel/locking/rwsem.c:1260    btrfs_page_mkwrite+0x417/0xc80 fs/btrfs/inode.c:8526    do_page_mkwrite+0x19e/0x5e0 mm/memory.c:2947    wp_page_shared+0x15e/0x380 mm/memory.c:3295    handle_pte_fault mm/memory.c:4949 [inline]    __handle_mm_fault mm/memory.c:5073 [inline]    handle_mm_fault+0x1b79/0x26b0 mm/memory.c:5219    do_user_addr_fault+0x69b/0xcb0 arch/x86/mm/fault.c:1428    handle_page_fault arch/x86/mm/fault.c:1519 [inline]    exc_page_fault+0x7a/0x110 arch/x86/mm/fault.c:1575    asm_exc_page_fault+0x22/0x30 arch/x86/include/asm/idtentry.h:570   RIP: 0010:copy_user_short_string+0xd/0x40 arch/x86/lib/copy_user_64.S:233   Code: 74 0a 89 (...)   RSP: 0018:ffffc9000570f330 EFLAGS: 000502---truncated---

### POC

#### Reference
- https://git.kernel.org/stable/c/519b7e13b5ae8dd38da1e52275705343be6bb508

#### Github
No PoCs found on GitHub currently.

