### [CVE-2024-57889](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-57889)
![](https://img.shields.io/static/v1?label=Product&message=Linux&color=blue)
![](https://img.shields.io/static/v1?label=Version&message=8f38910ba4f662222157ce07a0d5becc4328c46a%3C%20788d9e9a41b81893d6bb8faa05f045c975278318%20&color=brighgreen)
![](https://img.shields.io/static/v1?label=Vulnerability&message=n%2Fa&color=brighgreen)

### Description

In the Linux kernel, the following vulnerability has been resolved:pinctrl: mcp23s08: Fix sleeping in atomic context due to regmap lockingIf a device uses MCP23xxx IO expander to receive IRQs, the followingbug can happen:  BUG: sleeping function called from invalid context    at kernel/locking/mutex.c:283  in_atomic(): 1, irqs_disabled(): 1, non_block: 0, ...  preempt_count: 1, expected: 0  ...  Call Trace:  ...  __might_resched+0x104/0x10e  __might_sleep+0x3e/0x62  mutex_lock+0x20/0x4c  regmap_lock_mutex+0x10/0x18  regmap_update_bits_base+0x2c/0x66  mcp23s08_irq_set_type+0x1ae/0x1d6  __irq_set_trigger+0x56/0x172  __setup_irq+0x1e6/0x646  request_threaded_irq+0xb6/0x160  ...We observed the problem while experimenting with a touchscreen driver whichused MCP23017 IO expander (I2C).The regmap in the pinctrl-mcp23s08 driver uses a mutex for protection fromconcurrent accesses, which is the default for regmaps without .fast_io,.disable_locking, etc.mcp23s08_irq_set_type() calls regmap_update_bits_base(), and the latterlocks the mutex.However, __setup_irq() locks desc->lock spinlock before calling thesefunctions. As a result, the system tries to lock the mutex whole holdingthe spinlock.It seems, the internal regmap locks are not needed in this driver at all.mcp->lock seems to protect the regmap from concurrent accesses already,except, probably, in mcp_pinconf_get/set.mcp23s08_irq_set_type() and mcp23s08_irq_mask/unmask() are called underchip_bus_lock(), which calls mcp23s08_irq_bus_lock(). The latter takesmcp->lock and enables regmap caching, so that the potentially slow I2Caccesses are deferred until chip_bus_unlock().The accesses to the regmap from mcp23s08_probe_one() do not need additionallocking.In all remaining places where the regmap is accessed, exceptmcp_pinconf_get/set(), the driver already takes mcp->lock.This patch adds locking in mcp_pinconf_get/set() and disables internallocking in the regmap config. Among other things, it fixes the sleepingin atomic context described above.

### POC

#### Reference
No PoCs from references.

#### Github
- https://github.com/oogasawa/Utility-security

