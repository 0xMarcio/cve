### [CVE-2022-49441](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-49441)
![](https://img.shields.io/static/v1?label=Product&message=Linux&color=blue)
![](https://img.shields.io/static/v1?label=Version&message=&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=4.18%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=60c4e8db32815474bfaeabe888ebb14e698caea1%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=6d9cd12792270773fab9e5a129daff328d61ef9e%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=6dbfa9b5ae65063cd61dc7fa11332e00bb794d8b%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=b6da31b2c07c46f2dcad1d86caa835227a16d9ff%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=d83904cb2eb2c4d937eaf15032214b0578f25099%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Version&message=deb1feaad03a78b545c949e54582ae57b3c56982%20&color=brightgreen)
![](https://img.shields.io/static/v1?label=Vulnerability&message=n%2Fa&color=blue)

### Description

In the Linux kernel, the following vulnerability has been resolved:tty: fix deadlock caused by calling printk() under tty_port->lockpty_write() invokes kmalloc() which may invoke a normal printk() to printfailure message.  This can cause a deadlock in the scenario reported bysyz-bot below:       CPU0              CPU1                    CPU2       ----              ----                    ----                         lock(console_owner);                                                 lock(&port_lock_key);  lock(&port->lock);                         lock(&port_lock_key);                                                 lock(&port->lock);  lock(console_owner);As commit dbdda842fe96 ("printk: Add console owner and waiter logic toload balance console writes") said, such deadlock can be prevented byusing printk_deferred() in kmalloc() (which is invoked in the sectionguarded by the port->lock).  But there are too many printk() on thekmalloc() path, and kmalloc() can be called from anywhere, so changingprintk() to printk_deferred() is too complicated and inelegant.Therefore, this patch chooses to specify __GFP_NOWARN to kmalloc(), sothat printk() will not be called, and this deadlock problem can beavoided.Syzbot reported the following lockdep error:======================================================WARNING: possible circular locking dependency detected5.4.143-00237-g08ccc19a-dirty #10 Not tainted------------------------------------------------------syz-executor.4/29420 is trying to acquire lock:ffffffff8aedb2a0 (console_owner){....}-{0:0}, at: console_trylock_spinning kernel/printk/printk.c:1752 [inline]ffffffff8aedb2a0 (console_owner){....}-{0:0}, at: vprintk_emit+0x2ca/0x470 kernel/printk/printk.c:2023but task is already holding lock:ffff8880119c9158 (&port->lock){-.-.}-{2:2}, at: pty_write+0xf4/0x1f0 drivers/tty/pty.c:120which lock already depends on the new lock.the existing dependency chain (in reverse order) is:-> #2 (&port->lock){-.-.}-{2:2}:       __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:110 [inline]       _raw_spin_lock_irqsave+0x35/0x50 kernel/locking/spinlock.c:159       tty_port_tty_get drivers/tty/tty_port.c:288 [inline]          		<-- lock(&port->lock);       tty_port_default_wakeup+0x1d/0xb0 drivers/tty/tty_port.c:47       serial8250_tx_chars+0x530/0xa80 drivers/tty/serial/8250/8250_port.c:1767       serial8250_handle_irq.part.0+0x31f/0x3d0 drivers/tty/serial/8250/8250_port.c:1854       serial8250_handle_irq drivers/tty/serial/8250/8250_port.c:1827 [inline] 	<-- lock(&port_lock_key);       serial8250_default_handle_irq+0xb2/0x220 drivers/tty/serial/8250/8250_port.c:1870       serial8250_interrupt+0xfd/0x200 drivers/tty/serial/8250/8250_core.c:126       __handle_irq_event_percpu+0x109/0xa50 kernel/irq/handle.c:156       [...]-> #1 (&port_lock_key){-.-.}-{2:2}:       __raw_spin_lock_irqsave include/linux/spinlock_api_smp.h:110 [inline]       _raw_spin_lock_irqsave+0x35/0x50 kernel/locking/spinlock.c:159       serial8250_console_write+0x184/0xa40 drivers/tty/serial/8250/8250_port.c:3198										<-- lock(&port_lock_key);       call_console_drivers kernel/printk/printk.c:1819 [inline]       console_unlock+0x8cb/0xd00 kernel/printk/printk.c:2504       vprintk_emit+0x1b5/0x470 kernel/printk/printk.c:2024			<-- lock(console_owner);       vprintk_func+0x8d/0x250 kernel/printk/printk_safe.c:394       printk+0xba/0xed kernel/printk/printk.c:2084       register_console+0x8b3/0xc10 kernel/printk/printk.c:2829       univ8250_console_init+0x3a/0x46 drivers/tty/serial/8250/8250_core.c:681       console_init+0x49d/0x6d3 kernel/printk/printk.c:2915       start_kernel+0x5e9/0x879 init/main.c:713       secondary_startup_64+0xa4/0xb0 arch/x86/kernel/head_64.S:241-> #0 (console_owner){....}-{0:0}:       [...]       lock_acquire+0x127/0x340 kernel/locking/lockdep.c:4734       console_trylock_spinning kernel/printk/printk.c:1773 ---truncated---

### POC

#### Reference
- https://git.kernel.org/stable/c/b3c974501d0c32258ae0e04e5cc3fb92383b40f6

#### Github
No PoCs found on GitHub currently.

